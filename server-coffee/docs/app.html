<!DOCTYPE html>  <html> <head>   <title>app.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="aws_helper.html">                 aws_helper.coffee               </a>                                           <a class="source" href="config.html">                 config.coffee               </a>                                           <a class="source" href="daemon_interactor.html">                 daemon_interactor.coffee               </a>                                           <a class="source" href="db.html">                 db.coffee               </a>                                           <a class="source" href="log.html">                 log.coffee               </a>                                           <a class="source" href="login.html">                 login.coffee               </a>                                           <a class="source" href="scheduler.html">                 scheduler.coffee               </a>                                           <a class="source" href="scp.html">                 scp.coffee               </a>                                           <a class="source" href="ssh.html">                 ssh.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The <strong>wbGPU app</strong> is the main entry point to the <strong>wbGPU</strong> web server.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>External Modules</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We use express along with other libraries provided by node</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nv">express = </span><span class="nx">require</span> <span class="s">&#39;express&#39;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Markdown is used to convert the MPs to HTML files</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">markdown = </span><span class="p">(</span><span class="nx">require</span> <span class="s">&#39;node-markdown&#39;</span><span class="p">).</span><span class="nx">Markdown</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>config contains configurations such as the database address
the running port, etc...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">config = </span><span class="nx">require</span> <span class="s">&#39;./config&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Attempts are the past attempts of the user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">attempts = </span><span class="p">(</span><span class="nx">require</span> <span class="s">&#39;./db&#39;</span><span class="p">).</span><span class="nx">AttemptsProvider</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The scheduler provides an address to the the next available 
node. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">scheduler = </span><span class="nx">require</span> <span class="s">&#39;./scheduler&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Login communicates with the database to handle authentication
and sessions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">login = </span><span class="nx">require</span> <span class="s">&#39;./login&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Daemon is an interface to the daemon</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">daemon = </span><span class="nx">require</span> <span class="s">&#39;./daemon_interactor&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Everything is logged via the logger</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">log = </span><span class="p">(</span><span class="nx">require</span> <span class="s">&#39;./log&#39;</span><span class="p">).</span><span class="nx">log</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Global variables</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Start the express server </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">app = </span><span class="nx">express</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This server's address</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">address = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Because the login system is not setup, we are hard coding this</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">current_user = </span><span class="s">&#39;abduld&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>Configuration</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Configure the server with the propper port and where the public
directory maps to in the file system</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span> <span class="p">()</span> <span class="nf">-&gt;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;port&#39;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/public&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/../public&#39;</span><span class="p">)</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span> <span class="p">{</span>
    <span class="nv">dumpExceptions: </span><span class="kc">true</span><span class="p">,</span>
    <span class="nv">showStack: </span><span class="kc">true</span>
  <span class="p">}</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">app</span><span class="p">.</span><span class="nx">router</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Main Program</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Checks if the cookie points to an authenticated user, otherwise
redirect the user to the login page</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">is_authenticated = </span><span class="nf">(req, res, next) -&gt;</span>
  <span class="k">if</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user_id</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&#39;/login&#39;</span>
  <span class="k">else</span>
    <span class="nx">next</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>The login page contains fields for the user and password.
These fields are validated against the login server, if valid
then we forward the user to mp0, otherwise we show them the 
login page again.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nv">post = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
  <span class="nx">login</span><span class="p">.</span><span class="nx">valid_password</span> <span class="nx">post</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">pass</span><span class="p">,</span> <span class="nf">(err, valid) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something went wrong.&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>TODO: we need to store the session cookie</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&#39;/mp/0&#39;</span>
    <span class="k">else</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&#39;/login&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The signup page contains fields for the user and password.</p>

<p><strong>TODO</strong>: this page needs to be enhanced further</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/signup&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nv">post = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
  <span class="nx">login</span><span class="p">.</span><span class="nx">add_user</span> <span class="nx">post</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">pass</span><span class="p">,</span> <span class="nf">(err, obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something went wrong.&#39;</span>
    <span class="k">else</span>
      <span class="nv">req.session.user_id = </span><span class="p">{</span><span class="nv">user: </span><span class="nx">post</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nv">pass: </span><span class="nx">post</span><span class="p">.</span><span class="nx">pass</span><span class="p">}</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&#39;/mp/0&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Register slave is the entry point for the daemons to register their
services with the server. This information is passed back to the 
scheduler which adds them to the list of available daemons.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/register_slave&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>When I am debugging the submit functionality this is set to true.
This variable avoids calling the daemon to perform the computation,
instead the json response is read from a file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">i_am_debugging_submit = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>When a user hits the compute button on the web page, they are accessing
this method.</p>

<p><strong>TODO</strong>: some sort of the limitter on the amount of time between submits.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/mp/:id/submit&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="k">if</span> <span class="nx">i_am_debugging_submit</span> <span class="o">&amp;&amp;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="s">&#39;test_response.json&#39;</span>
    <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="s">&#39;test_response.json&#39;</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span> 
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The MP number</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">mp_id = </span><span class="nb">parseInt</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>We pass the task to the scheduler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">scheduler</span><span class="p">.</span><span class="nx">for_available_daemon</span> <span class="nf">(err, host) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;Server is busy&#39;</span>
      <span class="k">else</span>
        <span class="nv">program = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Data</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>daemon compute sends the </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">daemon</span><span class="p">.</span><span class="nx">compute</span> <span class="nx">host</span><span class="p">,</span>
                       <span class="nx">mp_id</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><strong>TODO</strong>: the MP configuration will be passed here eventually.
The MP config contains things like the grading scheme, what the inputs
are, and what the outputs are.</p>             </td>             <td class="code">               <div class="highlight"><pre>                       <span class="p">{</span>
                        <span class="nv">inputs: </span><span class="p">[],</span>
                        <span class="nv">output: </span><span class="s">&#39;&#39;</span><span class="p">,</span>
                        <span class="nv">program: </span><span class="nx">program</span>
                       <span class="p">},</span>
                       <span class="nf">(err, _r, body) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>When debugging we call this</p>             </td>             <td class="code">               <div class="highlight"><pre>                          <span class="k">if</span> <span class="nx">i_am_debugging_submit</span> 
                            <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="s">&#39;test_response.json&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">body</span><span class="p">),</span> <span class="s">&#39;ascii&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><strong>TODO</strong>: Better handeling for this</p>             </td>             <td class="code">               <div class="highlight"><pre>                          <span class="k">if</span> <span class="nx">err</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something broke!&#39;</span>
                          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The program text need to be stored in the database</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">body.ProgramText = </span><span class="nx">program</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Add the attempt to the database using both the current<em>user and mp</em>id as keys</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">attempts</span><span class="p">.</span><span class="nx">add_attempt</span> <span class="nx">current_user</span><span class="p">,</span> <span class="nx">mp_id</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nf">(err) -&gt;</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Send the results to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>The MP description is the text with the instructions on what the MP does</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id/description&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>the mp number</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>the path to the mp</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mp_path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.markdown&#39;</span>
  <span class="k">if</span> <span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">mp_path</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>we need to show a nicer page eventually</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.markdown not found&#39;</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>read the file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">mp_path</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;unable to read mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.markdown&#39;</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>use markdown to transform the file into html</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">html = </span><span class="nx">markdown</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>send the html result to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>The MP program is the starting program that users need to modify</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id/program&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>the mp number</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>the path to the template program</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mp_path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.cu&#39;</span>
  <span class="k">if</span> <span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">mp_path</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.markdown not found&#39;</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>read the file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">mp_path</span><span class="p">,</span> <span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;unable to read mp&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s">&#39;.markdown&#39;</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>send the file to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>The MP returns one HTML file, the HTML file has javascript
code that determines which program and text description to
fetch. This reduces the amount of code and avoids having to
write templates (it also deligates some of the work to 
the client's browser --- i.e. less load on the server).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nv">html_path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="s">&#39;mp.html&#39;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">sendfile</span> <span class="nx">html_path</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>The attempt count is just the number of times the user
tried the mp. the result is a number.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id/attempt_count&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p><strong>TODO</strong>: the user will be based on the session cookie</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">user = </span><span class="nx">current_user</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>query the database</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">attempts</span><span class="p">.</span><span class="nx">find_attempt</span> <span class="nx">user</span><span class="p">,</span>
                        <span class="nx">mp_id</span><span class="p">,</span>
                        <span class="nf">(err, data) -&gt;</span>
                          <span class="k">if</span> <span class="nx">err</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something broke!&#39;</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">data</span><span class="o">?</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">0</span>
                          <span class="k">else</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span><span class="p">.</span><span class="nx">attempts</span><span class="p">.</span><span class="nx">length</span>
  <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>The attempt summary is a snippet of the attempts
the user has made for the mp. The idea is to make
it have some information, but make it small.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id/attempt_summary&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p><strong>TODO</strong>: the user will be based on the session cookie</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">user = </span><span class="nx">current_user</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>the id of the mp</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mp_id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">attempts</span><span class="p">.</span><span class="nx">find_attempt</span> <span class="nx">user</span><span class="p">,</span>
                        <span class="nx">mp_id</span><span class="p">,</span>
                        <span class="nf">(err, data) -&gt;</span>
                          <span class="k">if</span> <span class="nx">err</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something broke!&#39;</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">data</span><span class="o">?</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="p">[]</span>
                          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>for each attempt, we reduce the data to generate a summary</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">attempts_summary = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">data</span><span class="p">.</span><span class="nx">attempts</span><span class="p">,</span> <span class="nf">(attempt) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>if a program failed to compile, then it does not contain the timer</p>             </td>             <td class="code">               <div class="highlight"><pre>                              <span class="nv">run_time = </span><span class="k">if</span> <span class="nx">attempt</span><span class="p">.</span><span class="nx">ProgramTimer</span><span class="o">?</span> <span class="k">then</span> <span class="nx">attempt</span><span class="p">.</span><span class="nx">ProgramTimer</span><span class="p">.</span><span class="nx">ElapsedTime</span> <span class="k">else</span> <span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>the summary of the attempts</p>             </td>             <td class="code">               <div class="highlight"><pre>                              <span class="p">{</span>
                                <span class="nv">id: </span><span class="nx">attempt</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                                <span class="nv">created_on: </span><span class="nx">attempt</span><span class="p">.</span><span class="nx">created_on</span><span class="p">,</span>
                                <span class="nv">elapsed_time: </span><span class="nx">attempt</span><span class="p">.</span><span class="nx">elapsed_time</span><span class="p">,</span>
                                <span class="nv">compile_failed: </span><span class="nx">attempt</span><span class="p">.</span><span class="nx">CompileFailed</span><span class="o">?</span><span class="p">,</span>
                                <span class="nv">program_failed: </span><span class="nx">attempt</span><span class="p">.</span><span class="nx">ProgramFailed</span><span class="o">?</span><span class="p">,</span>
                                <span class="nv">run_time: </span><span class="nx">run_time</span>
                              <span class="p">}</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">attempts_summary</span>
  <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>The attempt contains all the data stored about an attempt
on the server.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/mp/:id/attempt/:attempt_id&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><strong>TODO</strong>: the user will be based on the session cookie</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">user = </span><span class="nx">current_user</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>the id of the mp</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mp_id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">attempts</span><span class="p">.</span><span class="nx">find_attempt</span> <span class="nx">user</span><span class="p">,</span>
                        <span class="nx">mp_id</span><span class="p">,</span>
                        <span class="nf">(err, data) -&gt;</span>
                          <span class="k">if</span> <span class="nx">err</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something broke!&#39;</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">data</span><span class="o">?</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="kc">undefined</span>
                          <span class="k">else</span>
                            <span class="nv">attempt_id = </span><span class="nb">parseInt</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">attempt_id</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>find the attempt that matches the requested id</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">attempt = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">data</span><span class="p">.</span><span class="nx">attempts</span><span class="p">,</span> <span class="nf">(attempt) -&gt;</span> <span class="nx">attempt</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">attempt_id</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>if it exists then we return it, otherwise we return an error</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="k">if</span> <span class="nx">attempt</span><span class="o">?</span>
                              <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">attempt</span>
                            <span class="k">else</span>
                              <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="kc">undefined</span>
  <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>on not-found page, show a stub page</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nf">(req, res, next) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span><span class="p">,</span> <span class="s">&#39;page not found&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>on error, show a stub page</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nf">(err, req, res, next) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&#39;Something broke!&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <h3>Start the server</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="o">!</span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span>
  <span class="nv">port = </span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;port&#39;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Express server listening on port &quot;</span> <span class="o">+</span> <span class="nx">port</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>listen on the port set</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">server = </span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>get the address of the server and store it in the 
global variable</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">address = </span><span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 